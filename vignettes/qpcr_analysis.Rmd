---
title: "Analysis of qPCR data"
author: "Mahmoud Ahmed"
date: "`r Sys.Date()`"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(error = FALSE, message = FALSE)
```

```{r load libraries}
library(pcr)
library(ggplot2)
```

# Comparative CT methods  
## Double delta CT  

$$
\Delta\Delta C_T = \Delta C_{T,q} - \Delta C_{T,cb}
$$

$$
2^{-\Delta\Delta C_T}
$$

$$
s = \sqrt{s_1^2 + s_2^2}
$$

### separate tubes 

\begin{table}
\centering
\caption{Relative quantification using comparative ($\Delta\Delta C_T$) method (separate tubes)}
\label{table1}
\begin{tabular}{lccccc}
\hline
Tissue & c-myc $C_T$ & GAPDH $C_T$ & \begin{tabular}[c]{@{}c@{}}$\Delta C_T$\\ c-myc - GAPDH\end{tabular} & \begin{tabular}[c]{@{}c@{}}$\Delta\Delta C_T$\\ $\Delta C_T - \Delta C_{T,Brain}$\end{tabular} & \begin{tabular}[c]{@{}c@{}}c-myc\\ Rel. to Brain\end{tabular} \\
\hline
Brain & 30.72 & 23.7 &  &  &  \\
 & 30.34 & 23.56 &  &  &  \\
 & 30.58 & 23.47 &  &  &  \\
 & 30.34 & 23.65 &  &  &  \\
 & 30.5 & 23.69 &  &  &  \\
 & 30.43 & 23.68 &  &  &  \\
\textbf{Average} & 30.49 $\pm$ 0.15 & 23.63 $\pm$ 0.09 & 6.86 $\pm$ 0.17 & 0.00 $\pm$ 0.17 & 1.0 (0.9–1.1) \\
\hline
Kidney & 27.06 & 22.76 &  &  &  \\
 & 27.03 & 22.61 &  &  &  \\
 & 27.03 & 22.62 &  &  &  \\
 & 27.1 & 22.6 &  &  &  \\
 & 26.99 & 22.61 &  &  &  \\
 & 26.94 & 24.18 &  &  &  \\
\textbf{Average} & 27.03 $\pm$ 0.06 & 22.66 $\pm$ 0.08 & 4.37 $\pm$ 0.10 & –2.50 $\pm$ 0.10 & 5.6 (5.3–6.0) \\
\hline
\end{tabular}
\end{table}

```{r ddct_average_ct}
# default mode delta_delta_ct
## locate and read raw ct data
fl <- system.file('extdata', 'ct1.csv', package = 'pcr')
ct1 <- readr::read_csv(fl)

## add grouping variable
group_var <- rep(c('brain', 'kidney'), each = 6)

# calculate all values and errors in one step
## mode == 'average_ct' default
res <- pcr_analyze(ct1,
  group_var = group_var,
  reference_gene = 'GAPDH',
  reference_group = 'brain')
res
```

```{r plot_ddct_average_ct}
ggplot(res, aes(x = group, y = relative_expression)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower, ymax = upper))
```

### same tubes  

\begin{table}
\centering
\caption{Relative quantification using comparative ($\Delta\Delta C_T$) method (same tube)}
\label{table2}
\begin{tabular}{lccccc}
\hline
Tissue & c-myc $C_T$ & GAPDH $C_T$ & \begin{tabular}[c]{@{}c@{}}$\Delta C_T$\\ c-myc - GAPDH\end{tabular} & \begin{tabular}[c]{@{}c@{}}$\Delta\Delta C_T$\\ $\Delta C_T - Ave. \Delta C_{T,Brain}$\end{tabular} & \begin{tabular}[c]{@{}c@{}}c-myc\\ Rel. to Brain\end{tabular} \\
\hline
Brain & 32.38 & 25.07 & 7.31 &  &  \\
 & 32.08 & 25.29 & 6.79 &  &  \\
 & 32.35 & 25.32 & 7.03 &  &  \\
 & 32.08 & 25.24 & 6.84 &  &  \\
 & 32.34 & 25.17 & 7.17 &  &  \\
 & 32.13 & 25.29 & 6.84 &  &  \\
\textbf{Average} &  &  & 6.99 $\pm$ 0.21 & 0.00 $\pm$ 0.21 & 1.0 (0.86–1.15) \\
\hline
Kidney & 28.73 & 24.30 & 4.43 &  &  \\
 & 28.84 & 24.32 & 4.52 &  &  \\
 & 28.51 & 24.31 & 4.20 &  &  \\
 & 28.86 & 24.25 & 4.61 &  &  \\
 & 28.86 & 24.34 & 4.52 &  &  \\
 & 28.70 & 24.18 & 4.52 &  &  \\
Average &  &  & 4.47 $\pm$ 0.14 & –2.53 $\pm$ 0.14 & 5.77 (5.23–6.37) \\
\hline
\end{tabular}
\end{table}

```{r ddct_average_dct}
# calculate all values and errors in one step
## mode == 'average_dct'
res <- pcr_analyze(ct2,
  group_var = group_var,
  reference_gene = 'GAPDH',
  reference_group = 'brain',
  mode = 'average_dct')
res
```

```{r plote_ddct_average_dct}
ggplot(res, aes(x = group, y = relative_expression)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower, ymax = upper))
```

## Delata CT (choosing control genes)  

```{r dct_method}
# delta_ct method
## example to check fold change of control gens
## locate and read file
fl <- system.file('extdata', 'ct1.csv', package = 'pcr')
ct1 <- readr::read_csv(fl)

## make a data.frame of two identical columns
pcr_hk <- data.frame(
  GAPDH1 = ct1$GAPDH,
  GAPDH2 = ct1$GAPDH
  )

## add grouping variable
group_var <- rep(c('brain', 'kidney'), each = 6)

## calculate caliberation
res <- pcr_analyze(pcr_hk,
            group_var = group_var,
            reference_group = 'brain',
            method = 'delta_ct')
res
```

```{r plot_dct_method}
ggplot(res, aes(x = group, y = fold_change, group = gene, fill = gene)) +
  geom_col(position = 'dodge') +
  geom_errorbar(aes(ymin = lower, ymax = upper, group = gene))
```

## Assessing amplification effeciency  

\begin{table}
\centering
\caption{Average $C_T$ value for c-myc and GAPDH at different input amounts}
\label{table3}
\begin{tabular}{@{}cccc@{}}
\hline
\begin{tabular}[c]{@{}c@{}}Input RNA\\ (ng)\end{tabular} & \begin{tabular}[c]{@{}c@{}}c-myc\\ Average $C_T$\end{tabular} & \begin{tabular}[c]{@{}c@{}}GAPDH\\ Average $C_T$\end{tabular} & \begin{tabular}[c]{@{}c@{}}$\Delta C_T$\\ c-myc - GAPDH\end{tabular} \\
\hline
1.0 & 25.59 $\pm$ 0.04 & 22.64 $\pm$ 0.03 & 2.95 $\pm$ 0.05 \\
0.5 & 26.77 $\pm$ 0.09 & 23.73 $\pm$ 0.05 & 3.04 $\pm$ 0.10 \\
0.2 & 28.14 $\pm$ 0.05 & 25.12 $\pm$ 0.10 & 3.02 $\pm$ 0.11 \\
0.1 & 29.18 $\pm$ 0.13 & 26.16 $\pm$ 0.02 & 3.01 $\pm$ 0.13 \\
0.05 & 30.14 $\pm$ 0.03 & 27.17 $\pm$ 0.06 & 2.97 $\pm$ 0.07 \\
0.02 & 31.44 $\pm$ 0.16 & 28.62 $\pm$ 0.10 & 2.82 $\pm$ 0.19 \\
0.02 & 32.42 $\pm$ 0.12 & 29.45 $\pm$ 0.08 & 2.97 $\pm$ 0.14 \\
\hline
\end{tabular}
\end{table}

```{r calculate_effeciency}
## locate and read data
fl <- system.file('extdata', 'ct3.csv', package = 'pcr')
ct3 <- readr::read_csv(fl)

## make a vector of RNA amounts
amount <- rep(c(1, .5, .2, .1, .05, .02, .01), each = 3)

## calculate amplification effeciency
res <- pcr_assess(ct3,
                  amount = amount,
                  reference_gene = 'GAPDH',
                  method = 'effeciency')
res
```

```{r plot_effeciency}
pcr_assess(ct3,
           amount = amount,
           reference_gene = 'GAPDH',
           method = 'effeciency',
           plot = TRUE)
```

# statndard curve methods  
$$
\log amount = \dfrac{C_T - b}{m}
$$

$$
10^{\log amount}
$$

$$
cv = \sqrt{cv_1^2 + cv_2^2}
$$

$$
s = (cv)(\bar X)
$$

## calculating standard curve

```{r calculating_curve}
## calculate standard curve
res <- pcr_assess(ct3,
                  amount = amount,
                  method = 'standard_curve')
res
```

```{r plot_curves}
pcr_assess(ct3,
           amount = amount,
           method = 'standard_curve',
           plot = TRUE)
```

```{r retain_variable}
intercept <- res$intercept
slope <- res$slope
```

## separate tubes

\begin{table}
\centering
\caption{Relative quantification using the standard curve method (separate tube)}
\label{table4}
\begin{tabular}{@{}lcccc@{}}
\hline
Tissue & c-myc (ng) & GAPDH (ng) & \begin{tabular}[c]{@{}c@{}}c-myc\\ norm. to GAPDH\end{tabular} & \begin{tabular}[c]{@{}c@{}}c-myc \\ Rel. to Brain\end{tabular} \\ 
\hline
Brain & 0.033 & 0.51 &  &  \\
 & 0.043 & 0.56 &  &  \\
 & 0.036 & 0.59 &  &  \\
 & 0.043 & 0.53 &  &  \\
 & 0.039 & 0.51 &  &  \\
 & 0.040 & 0.52 &  &  \\
\textbf{Average} & 0.039 $\pm$ 0.004 & 0.54 $\pm$ 0.034 & 0.07 $\pm$ 0.008 & 1.0 $\pm$ 0.12 \\
\hline
Kidney & 0.40 & 0.96 &  &  \\
 & 0.41 & 1.06 &  &  \\
 & 0.41 & 1.05 &  &  \\
 & 0.39 & 1.07 &  &  \\
 & 0.42 & 1.06 &  &  \\
 & 0.43 & 0.96 &  &  \\
\textbf{Average} & 0.41 $\pm$ 0.016 & 1.02 $\pm$ 0.052 & 0.40 $\pm$ 0.025 & 5.5 $\pm$ 0.35 \\ 
\hline
\end{tabular}
\end{table}

```{r standard_average_amounts}
## calculate standard amounts and error
res <- pcr_analyze(ct1,
                   group_var = group_var,
                   reference_gene = 'GAPDH',
                   reference_group = 'brain',
                   intercept = intercept,
                   slope = slope,
                   method = 'relative_curve')
res
```

```{r plot_standard_average_amounts}
ggplot(res, aes(x = group, y = caliberated)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower, ymax = upper))
```

## Same tubes  

\begin{table}
\centering
\caption{Relative quantification using the standard curve method (same tube)}
\label{table5}
\begin{tabular}{lcccc}
\hline
Tissue & c-myc (ng) & GAPDH (ng) & \begin{tabular}[c]{@{}c@{}}c-myc\\ norm. to GAPDH\end{tabular} & \begin{tabular}[c]{@{}c@{}}c-myc\\ Rel. to Brain\end{tabular} \\
\hline
Brain & 0.031 & 0.618 & 0.05 &  \\
 & 0.038 & 0.532 & 0.07 &  \\
 & 0.032 & 0.521 & 0.06 &  \\
 & 0.038 & 0.550 & 0.07 &  \\
 & 0.032 & 0.577 & 0.06 &  \\
 & 0.037 & 0.532 & 0.07 &  \\
\textbf{Average} &  &  & 0.06 $\pm$ 0.008 & 1.0 $\pm$ 0.14 \\
\hline
Kidney & 0.365 & 0.049 & 0.35 &  \\
 & 0.338 & 1.035 & 0.33 &  \\
 & 0.423 & 1.042 & 0.41 &  \\
 & 0.334 & 1.086 & 0.31 &  \\
 & 0.334 & 1.021 & 0.33 &  \\
 & 0.372 & 1.139 & 0.33 &  \\
\textbf{Average} &  &  & 0.34 $\pm$ 0.035 & 5.4 $\pm$ 0.55 \\
\hline
\end{tabular}
\end{table}

```{r standard_average_normalized}
## calculate standard amounts and error
res <- pcr_analyze(ct1,
                   group_var = group_var,
                   reference_gene = 'GAPDH',
                   reference_group = 'brain',
                   intercept = intercept,
                   slope = slope,
                   method = 'relative_curve',
                   mode = 'average_normalized')
res
```

```{r plot_standard_average_normalized}
ggplot(res, aes(x = group, y = caliberated)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower, ymax = upper))
```

# Statistical significance

\begin{table}
\centering
\caption{Statistical significance using different testing methods}
\label{table6}
\begin{tabular}{@{}lccc@{}}
\hline
Test & \begin{tabular}[c]{@{}c@{}}$\Delta\Delta C_T$\\ (estimate)\end{tabular} & \textit{p-value} & Confidence Interval \\ \hline
Multiple Regression & -0.6848 & \textless 0.0001 & (-0.4435, -0.9262) \\
ANOVA & -0.6848 & \textless 0.0001 & (-0.4435, -0.9262) \\
\textit{t-test} & -0.6848 & \textless 0.0001 & (-0.4147, -0.955) \\
Wilcoxon test & -0.6354 & \textless 0.0001 & (-0.4227, -0.8805) \\ \hline
\end{tabular}
\end{table}

```{r testing_t.test}
# locate and read data
fl <- system.file('extdata', 'ct4.csv', package = 'pcr')
ct4 <- readr::read_csv(fl)

# make group variable
group <- rep(c('control', 'treatment'), each = 12)

# test using t-test
pcr_test(ct4,
         group_var = group,
         reference_gene = 'ref',
         reference_group = 'control',
         test = 't.test')
```

```{r testing_wilcox}
# test using wilcox.test
pcr_test(ct4,
         group_var = group,
         reference_gene = 'ref',
         reference_group = 'control',
         test = 'wilcox.test')
```

```{r testing_lm}
# testing using lm
pcr_test(ct4,
         group_var = group,
         reference_gene = 'ref',
         reference_group = 'control',
         test = 'lm')
```

